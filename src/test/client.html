<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cliente WebSocket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #messages {
      list-style-type: none;
      padding: 0;
    }
    #messages li {
      padding: 5px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>Cliente WebSocket</h1>
  
  <div>
    <input type="text" id="tokenInput" placeholder="Seu Token JWT">
    <button onclick="authenticate()">Autenticar</button>
  </div>
  
  <div>
    <input type="text" id="recipientIdInput" placeholder="ID do Destinatário">
    <input type="text" id="messageInput" placeholder="Digite uma mensagem">
    <button onclick="sendMessage()">Enviar</button>
  </div>

  <ul id="messages"></ul>

  <script>
    let ws;
    let token = '';

    function authenticate() {
      token = document.getElementById('tokenInput').value;
      if (!token) {
        alert('Por favor, insira um Token JWT.');
        return;
      }

      ws = new WebSocket('ws://localhost:3000/chat');

      ws.onopen = () => {
        console.log('Conectado ao servidor WebSocket');
        ws.send(JSON.stringify({ type: 'authenticate', token }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const messages = document.getElementById('messages');
        const li = document.createElement('li');

        // Verifique se a mensagem contém dados
        if (data.message) {
          li.textContent = `Recebido: ${data.message} (De: ${data.from_user.username})`;
        } else if (data.error) {
          li.textContent = `Erro: ${data.error}`;
        }

        messages.appendChild(li);
      };

      ws.onclose = () => {
        console.log('Desconectado do servidor WebSocket');
      };

      ws.onerror = (error) => {
        console.error('Erro no WebSocket:', error);
      };
    }

    function sendMessage() {
      const recipientId = document.getElementById('recipientIdInput').value;
      const message = document.getElementById('messageInput').value;
      if (!recipientId || !message) {
        alert('Por favor, insira o ID do destinatário e a mensagem.');
        return;
      }

      if (!token) {
        alert('Você precisa se autenticar primeiro.');
        return;
      }

      const chatMessage = {
        type: 'message',
        to_user_id: parseInt(recipientId),
        message: message
      };

      ws.send(JSON.stringify(chatMessage));
      console.log(`Enviado para ${recipientId}: ${message}`);
    }
  </script>
</body>
</html>
